!function(e){"use strict";e.module("liveblog-embed",["ngResource","angular-cache"]).constant("config",{blog:window.LB.blog,settings:window.LB.settings,api_host:window.LB.api_host,assets_root:window.LB.assets_root})}(angular),function(e){"use strict";function t(t){return function(n){if(n.picture_url&&n.picture){var i="";e.forEach(n.picture.renditions,function(e){i+=", "+t(e.href)+" "+e.width+"w"}),n.picture_srcset=i.substring(2),n.picture_url=t(n.picture_url)}return n}}function n(t,n,i){return t(n.api_host+'api/client_blogs/:blogId?embedded={"picture":1}',{blogId:n.blog._id},{get:{method:"GET",transformResponse:function(t){return t=e.fromJson(t),i(t)}}})}function i(e,t,n){return n.get("usersCache")||n.createCache("usersCache",a),e(t.api_host+"api/client_users/:userId",{userId:"@id"},{get:{method:"GET",cache:n.get("usersCache")}})}function r(t,n,i){function r(e){return e.commenter?e.original_creator={display_name:e.commenter}:""!==e.original_creator&&"None"!==e.original_creator&&i.get({userId:e.original_creator},function(t){e.original_creator=t._items?t._items[0]:t}),e}return t(n.api_host+"api/client_blogs/:blogId/posts",{blogId:n.blog._id},{get:{transformResponse:function(t){return t=e.fromJson(t),t._items.forEach(function(t){t.mainItem=r(t.groups[1].refs[0].item),t.hasComments=_.reduce(t.groups[1].refs,function(e,t){return e||!_.isUndefined(t.item.commenter)},!1),t.fullDetails=t.hasComments,t.showUpdate=t._updated!==t.published_date&&!t.hasComments&&"comment"!==t.mainItem.item_type,e.isDefined(t.groups[1])&&(t.items=t.groups[1].refs.map(function(e){var n=e.item;return t.fullDetails?(r(n),n.displayDate=n.meta&&n.meta._created||n._created):n.displayDate=t.published_date,n})),r(t)}),t}}})}function o(e,t){return e(t.api_host+"api/client_comments/")}function s(e,t){return e(t.api_host+"api/client_items/")}var a={deleteOnExpire:"aggressive",recycleFreq:36e5,storageMode:"localStorage"};t.$inject=["fixProtocol"],n.$inject=["$resource","config","transformBlog"],i.$inject=["$resource","config","CacheFactory"],r.$inject=["$resource","config","users"],o.$inject=["$resource","config"],s.$inject=["$resource","config"],e.module("liveblog-embed").service("users",i).service("posts",r).service("blogs",n).service("comments",o).service("items",s).factory("transformBlog",t)}(angular),function(e){"use strict";function t(e){return e.replace(/(<([^>]+)>)/gi,"")}function n(e,t,n,i){function r(r,o){this.send=function(r){var o=n.defer();return r.client_blog=i.blog._id,r.item_type="comment",t.save(r).$promise.then(function(t){if("ERR"===t._status)return void o.reject("Try again later!");var n={post_status:"comment",client_blog:i.blog._id,groups:[{id:"root",refs:[{idRef:"main"}],role:"grpRole:NEP"},{id:"main",refs:[{residRef:t._id}],role:"grpRole:Main"}]};e.save(n).$promise.then(function(e){return"ERR"===e._status?void o.reject("Try again later!"):void o.resolve(e)})},function(e){o.reject("Try again later!")}),o.promise}}return r}function i(n){var i=n;e.extend(i,{modal:!0,notify:!1,form:!0,reset:function(){i.form||(i.commenter=void 0,i.content=void 0)},toggle:function(e){i.notify?(i.notify=!1,i.form=!1,i.modal=!1,i.reset()):(i.modal=!i.modal,i.form=!i.form,i.reset())},send:function(){return!i.commenter||i.commenter.length<3||i.commenter.length>30||!i.content||i.content.length<3||i.content.length>300?(i.commenter=void 0===i.commenter?"":i.commenter,i.content=void 0===i.content?"":i.content,!1):(i.notify="sended",i.form=!1,void commentsManager.send({commenter:t(i.commenter),text:t(i.content)}).then(function(){i.reset(),$timeout(function(){i.notify&&(i.notify=!1,i.form=!0,i.comment=!1)},2500)}))}})}n.$inject=["comments","items","$q","config"],i.$inject=["$scope"],e.module("liveblog-embed").factory("CommentsManager",n).directive("lbComments",["CommentsManager","$timeout","asset",function(e,t,n){new e;return{scope:{comment:"="},templateUrl:n.templateUrl("views/comments.html"),controller:i,link:function(e,t,n){e.comment=!1,e.$watch("comment",e.toggle)}}}])}(angular),function(e){"use strict";function t(t,n,i){function r(r,o,s){function a(e){return{posts:e||[],addPost:function(e){this.posts.push(e)}}}function c(e,n){var i=E.highlight?{filtered:{filter:{and:[{term:{sticky:s}},{term:{post_status:"open"}},{term:{highlight:!0}},{not:{term:{deleted:!0}}}]}}}:{filtered:{filter:{and:[{term:{sticky:s}},{term:{post_status:"open"}},{not:{term:{deleted:!0}}}]}}},r={source:{query:i,sort:[x[E.sort]]},page:e,max_results:n||E.maxResults};return t.get(r).$promise.then(function(e){return E.meta=e._meta,e})}function u(e){return E.highlight=e,E.pages=[],d()}function l(e){return E.sort=e,E.pages=[],d()}function m(e){return e?void(E.sort=e):E.sort}function d(){var e=n.when();return 0===E.pages.length&&(e=E.retrieveUpdate().then(function(e){p(e._items)})),e.then(function(){return v(0,E.pages.length+1)})}function f(i){i=i===!0;var r=E.latestUpdatedDate?E.latestUpdatedDate.utc().format():void 0,o={page:1,source:{sort:[{_updated:{order:"desc"}}],query:{filtered:{filter:{and:[{range:{_updated:{gt:r}}}]}}}}};return t.get(o).$promise.then(function(i){var s=i._meta;if(s.total<=s.max_results*s.page||!e.isDefined(r))return i;for(var a=[],c=s.page+1;c<=Math.floor(s.total/s.max_results)+1;c++)o.page=c,a.push(t.get(o).$promise);return n.all(a).then(function(t){return e.extend({},t[0],{_items:[].concat.apply([],t.map(function(e){return e._items})),_meta:e.extend(s,{max_results:s.max_results*t.length})})})}).then(function(e){return i&&g(e._items),e})}function g(t){t.forEach(function(t){var n=b(t);e.isDefined(n)?t.deleted?$(t):"open"!==t.post_status||t.sticky!==s?$(t):(E.pages[n[0]].posts[n[1]]=t,h()):t.deleted||"open"!==t.post_status||t.sticky!==s||y(t)}),p(t)}function p(t){var n;t.forEach(function(t){n=moment(t._updated),e.isDefined(E.latestUpdatedDate)?E.latestUpdatedDate.diff(n)<0&&(E.latestUpdatedDate=n):E.latestUpdatedDate=n})}function h(t){t=t||E.allPosts(),E.pages=[];var n=Object.keys(x[E.sort])[0],i=x[E.sort][n].order;t=_.sortByOrder(t,n,i);var r;t.forEach(function(e,t){t%E.maxResults===0&&(r=new a),r.addPost(e),r.posts.length===E.maxResults&&(w(r),r=void 0)}),e.isDefined(r)&&w(r)}function v(e,t){return t=t||E.pages.length,c(1,t*E.maxResults).then(function(e){return h(e._items),e})}function b(e){for(var t,n=0;n<E.pages.length;n++){t=E.pages[n];for(var i=0;i<t.posts.length;i++)if(t.posts[i]._id===e._id)return[n,i]}}function y(t){var n=E.allPosts();e.isArray(t)||(t=[t]),t.forEach(function(t){e.isDefined(b(t))||n.push(t)}),h(n),p(n)}function $(t){var n=b(t);if(e.isDefined(t)){var i=n[0],r=n[1];E.pages[i].posts.splice(r,1),h(E.allPosts())}}function w(e){E.pages.push(e)}var x={editorial:{order:{order:"desc",missing:"_last",unmapped_type:"long"}},newest_first:{published_date:{order:"desc",missing:"_last",unmapped_type:"long"}},oldest_first:{published_date:{order:"asc",missing:"_last",unmapped_type:"long"}}},E=this;e.extend(E,{pages:[],meta:{},sort:o||i.settings.postOrder,changeHighlight:u,changeOrder:l,order:m,maxResults:r||i.settings.postsPerPage,latestUpdatedDate:void 0,fetchNewPage:d,retrieveUpdate:f,applyUpdates:g,allPosts:function(){var e=E.pages.map(function(e){return e.posts.map(function(e){return e})}),t=[];return t.concat.apply(t,e)}})}return r}t.$inject=["posts","$q","config"],e.module("liveblog-embed").factory("PagesManager",t)}(angular),function(e){"use strict";e.module("liveblog-embed").factory("Permalink",["$q","$timeout","config",function(t,n,i){return function(i,r){function o(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}var s,a="liveblog._id",c=r;if(document.parent)try{s=document.location.href}catch(u){s=document.referrer}else s=document.location.href;var l,m=new RegExp(o(a)+"=([^&#]*)"),l=s.match(m);if(l){var d=decodeURIComponent(l[1]).split("->");this._id=d[0],i.order(d[1])}this.get=function(e){var t=!1,n=a+"="+e+"->"+i.order();if(-1===s.indexOf(c))t=s+c+n;else if(-1!==s.indexOf(a+"=")){var r=new RegExp(o(a)+"=[^&#]*");t=s.replace(r,n)}else t=s+"&"+n;return t},this.loadPost=function(){var r=t.defer(),o=this,s=!1;return o._id?(e.forEach(i.allPosts(),function(e){e._id===o._id&&(s=!0)}),s?n(function(){r.resolve(o._id)}):i.fetchNewPage().then(function(){o.loadPost()})):r.reject(),r.promise}}}])}(angular),function(e){"use strict";e.module("liveblog-embed").factory("fixProtocol",["config",function(e){return function(t){var n=RegExp(/http(s)?:\/\//gi);e.api_host.split("//").pop();return e.api_host.replace(n,"//"),t.replace(n,"//"),t.replace(n,"//")}}]).provider("asset",["$injector",function(e){this.templateUrl=function(t){var n=e.get("config"),i=t;return/^(https?:\/\/|\/\/)/.test(t)||(i=n.assets_root+"/"+i),i=i.replace(/[^\/]+\/+\.\.\//g,"").replace(/\.\//g,"").replace(/(\w)\/\/(\w)/g,"$1/$2")},this.imageUrl=this.templateUrl,this.$get=function(){return this}}])}(angular),function(e){"use strict";e.module("liveblog-embed").directive("lbBindHtml",[function(){return{restrict:"A",link:function(e,t,n){n.$observe("htmlContent",function(){n.htmlLocation?t.find("["+n.htmlLocation+"]").html(n.htmlContent):t.html(n.htmlContent)})}}}]).directive("lbFluidIframe",["$timeout","$window",function(t,n){return{restrict:"EA",link:function(i,r,o){function s(){var e=r.innerWidth();a.width(e).height(e*a.data("aspectRatio"))}var a;t(function(){a=r.find("iframe"),a.data("aspectRatio",a.attr("height")/a.attr("width")).removeAttr("height").removeAttr("width"),s()},1e3),e.element(n).bind("resize",_.debounce(s,1e3))}}}]).directive("lbTwitterCard",[function(){return{restrict:"E",link:function(e,t,n){t.html(n.lbTwitterContent)}}}]).directive("lbGenericEmbed",["$timeout","$window",function(t,n){return{scope:{item:"="},template:['<div ng-if="isEmbedCode" class="item--embed" lb-bind-html html-content="{{item.meta.html}}"></div>','<article class="item--embed">','    <img ng-if="!isEmbedCode && item.meta.thumbnail_url" ng-src="{{ item.meta.thumbnail_url }}" class="item--embed__illustration"/>','    <div class="item--embed__title" ng-if="item.meta.title">','        <a ng-href="{{ item.meta.url }}" target="_blank" ng-bind="item.meta.title"></a>',"    </div>",'    <div class="item--embed__description" ng-if="item.meta.description" ng-bind="item.meta.description"></div>','    <div class="item--embed__credit" ng-if="item.meta.credit" ng-bind="item.meta.credit"></div>',"</article>"].join(""),link:function(i,r){var o=function(){t(function(){var e=r.find(".item--embed__illustration").width();if(e){var t=i.item.meta.thumbnail_height/i.item.meta.thumbnail_width*e;r.find(".item--embed").css("min-height",t)}})};i.isEmbedCode=e.isDefined(i.item.meta.html),i.isEmbedCode||(o(),e.element(n).bind("resize",_.debounce(o,1e3)))}}}])}(angular),function(e){"use strict";e.module("liveblog-embed").filter("prettifyIsoDate",function(){return function(e){return moment(e).format("DD/MM/YYYY  HH:mm")}}).filter("outboundAnchors",function(){return function(e){return e.replace(/<a([^>]*)>/g,function(e,t){return-1===t.indexOf("target")?"<a"+t+' target="_blank">':e})}}).filter("convertLinksWithRelativeProtocol",["fixProtocol",function(e){return e}])}(angular);